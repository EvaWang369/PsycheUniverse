<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metaphors - Psyche</title>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-W28H9GH9BL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-W28H9GH9BL');
  </script>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>✨</text></svg>">
  <link rel="stylesheet" href="/views/css/game.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <!-- Navigation -->
  <nav>
    <img src="../logos/logo.jpg" alt="Psyche" class="logo" style="height: 40px; width: auto;">
    <div class="nav-links">
      <a href="/">Home</a>

      <!-- Mode Switch in Navbar -->
      <div class="nav-mode-switch" role="tablist" aria-label="Library Mode">
        <button class="nav-mode-tab active" id="tabMetaphor" onclick="setMode('metaphor')" aria-selected="true">
          Metaphors
        </button>
        <button class="nav-mode-tab" id="tabVideo" onclick="setMode('video')" aria-selected="false">
          Frequencies
        </button>
      </div>

      <a href="#bundles-section" class="nav-bundles-cta">Unlock Bundles →</a>

      <div class="user-menu">
        <button class="auth-btn" id="authBtn" onclick="handleAuthClick()">Sign In</button>
        <div class="user-dropdown" id="userDropdown">
          <p id="userEmail"></p>
          <span class="vip-badge" id="vipBadge">FREE</span>
          <button class="logout-btn" onclick="AuthManager.logout()">Sign Out</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section with Animated Visuals -->
  <section class="hero">
    <div class="hero-content">
      <h1 id="heroTitle">METAPHOR LIBRARY</h1>
      <p class="subtitle" id="heroSubtitle">Reality, Explained Through Lenses</p>
      <p id="heroDesc">These are playful models.<br>They help you feel the law, faster.</p>
    </div>

    <div class="hero-media">
      <div class="hero-visual">
        <!-- Metaphor Mode Visual -->
        <div class="metaphor-visual" id="metaphorVisual">
          <div class="glow-ring"></div>
          <div class="glow-ring"></div>
          <div class="glow-ring"></div>
          <span class="floating-symbol">◇</span>
          <span class="floating-symbol">✦</span>
          <span class="floating-symbol">◈</span>
          <span class="floating-symbol">✧</span>
          <div class="prism"></div>
        </div>

        <!-- Frequency Mode Visual -->
        <div class="frequency-visual hidden" id="frequencyVisual">
          <div class="wave-container">
            <div class="wave-circle"></div>
            <div class="wave-circle"></div>
            <div class="wave-circle"></div>
            <div class="wave-circle"></div>
            <div class="wave-circle"></div>
            <div class="center-orb"></div>
          </div>
          <span class="hz-label">528 Hz</span>
        </div>
      </div>
    </div>
  </section>

  <!-- METAPHOR MODE (cards) -->
  <div id="metaphorMode">
    <!-- Core Lenses Section -->
    <section id="core-lenses">
      <div class="section-header">
        <h2 class="section-title">CORE LENSES</h2>
        <p class="section-subtitle">The foundational mirrors</p>
      </div>
      <div class="metaphor-grid" id="coreGrid">
        <!-- Cards will be loaded dynamically -->
      </div>
    </section>

    <!-- More Lenses Section -->
    <div class="expand-section">
      <button class="expand-btn" id="expandBtn" onclick="toggleMoreLenses()">MORE LENSES</button>
    </div>

    <section id="more-lenses" style="display: none;">
      <div class="metaphor-grid" id="moreGrid">
        <!-- More cards will be loaded dynamically -->
      </div>
    </section>

    <!-- Expanding Library Section -->
    <section id="expanding-library">
      <div class="section-header">
        <h2 class="section-title">EXPANDING LIBRARY</h2>
        <p class="section-subtitle">Coming soon</p>
      </div>
      <div class="metaphor-grid" id="expandingGrid">
        <!-- Coming soon cards will be loaded dynamically -->
      </div>
    </section>

    <!-- Suggest Metaphor Section -->
    <section class="suggest-section">
      <div class="suggest-content">
        <div class="suggest-symbol">✦</div>
        <div class="suggest-text">
          <h3>SUGGEST A METAPHOR</h3>
          <p>Help us expand the library · Community · Co-creation</p>
        </div>
        <button class="btn btn-unlock" onclick="openSuggestionModal()">Share Your Idea →</button>
      </div>
    </section>
  </div>

  <!-- VIDEO MODE (frequencies) -->
  <div id="videoMode" style="display:none;">
    <section id="frequency-vault">
      <div class="section-header">
        <h2 class="section-title">FREQUENCY VAULT</h2>
        <p class="section-subtitle">High-frequency visual sessions for clarity and calm</p>
      </div>
      <div class="metaphor-grid" id="frequencyGrid">
        <!-- Video cards will be loaded dynamically -->
      </div>
    </section>
  </div>

  <!-- Bundle Section (always visible) -->
  <section id="bundles-section" style="padding: 2.5rem 2rem;">
    <div class="section-header">
      <h2 class="section-title">UNLOCK BUNDLES</h2>
      <p class="section-subtitle">Save with bundle offers</p>
    </div>
    <div class="metaphor-grid" id="bundlesGrid">
      <!-- Bundle cards will be loaded dynamically -->
    </div>
  </section>

  <!-- Doctrine Footer -->
  <div class="doctrine-footer">
    <p>These metaphors are not Psyche.<br>They are mirrors—tiny models that help you recognize one law.</p>
    <a href="/" class="btn btn-preview">Read the Psyche System →</a>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Suggestion Modal -->
  <div id="suggestionModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeSuggestionModal()">&times;</span>
      <h2>Suggest a Metaphor</h2>
      <p class="modal-keywords">Help us expand the library</p>
      <form class="suggestion-form" onsubmit="submitSuggestion(event)">
        <input type="text" name="name" placeholder="Your name (optional)">
        <input type="email" name="email" placeholder="Your email (optional)">
        <textarea name="suggestion" placeholder="Your metaphor suggestion" required></textarea>
        <textarea name="reason" placeholder="Why it fits Psyche"></textarea>
        <button type="submit" class="btn btn-unlock">Submit Suggestion</button>
      </form>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content auth-modal-content">
      <span class="modal-close" onclick="closeAuthModal()">&times;</span>
      <h2>Welcome</h2>
      <div id="googleSignIn"></div>
    </div>
  </div>

  <script src="/views/js/auth.js"></script>
  <script src="/views/js/metaphor-catalog.js"></script>
  <script src="/views/js/metaphor-ui.js"></script>
  <script src="/views/js/suggestions.js"></script>
  <script src="/views/js/frequency-catalog.js"></script>
  <script src="/views/js/mode-switch.js"></script>
  <script>
    // ========================================
    // UI HELPER FUNCTIONS
    // ========================================

    function toggleMoreLenses() {
      const section = document.getElementById('more-lenses');
      const btn = document.getElementById('expandBtn');

      if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.classList.add('expanded');
      } else {
        section.style.display = 'none';
        btn.classList.remove('expanded');
      }
    }

    function closeModal() {
      const modal = document.getElementById('previewModal');
      modal.classList.remove('active');
      // Stop video playback when closing
      const iframe = modal.querySelector('iframe');
      if (iframe) {
        iframe.src = iframe.src;
      }
    }

    function openSuggestionModal() {
      document.getElementById('suggestionModal').classList.add('active');
    }

    function closeSuggestionModal() {
      document.getElementById('suggestionModal').classList.remove('active');
    }

    function openAuthModal() {
      document.getElementById('authModal').classList.add('active');
      if (typeof initGoogleSignIn === 'function') {
        initGoogleSignIn();
      }
    }

    function closeAuthModal() {
      document.getElementById('authModal').classList.remove('active');
    }

    function handleAuthClick() {
      if (typeof AuthManager !== 'undefined' && AuthManager.isLoggedIn()) {
        toggleUserDropdown();
      } else {
        openAuthModal();
      }
    }

    function toggleUserDropdown() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.toggle('active');
    }

    function closeUserDropdown() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.remove('active');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const userMenu = document.querySelector('.user-menu');
      if (userMenu && !userMenu.contains(e.target)) {
        closeUserDropdown();
      }
    });

    async function submitSuggestion(e) {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const response = await fetch('/api/metaphor-suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: formData.get('name'),
            email: formData.get('email'),
            suggestion: formData.get('suggestion'),
            reason: formData.get('reason')
          })
        });

        const data = await response.json();

        if (response.ok) {
          alert('Thank you for your suggestion! We will review it soon.');
          closeSuggestionModal();
          e.target.reset();
        } else {
          alert(data.error || 'Failed to submit suggestion.');
        }
      } catch (error) {
        alert('Network error. Please try again later.');
      }
    }

    // ========================================
    // INITIALIZATION
    // ========================================

    window.addEventListener('load', () => {
      // Initialize auth UI if AuthManager exists
      if (typeof AuthManager !== 'undefined') {
        AuthManager.updateUI();
        if (AuthManager.isLoggedIn()) {
          AuthManager.refreshUser();
        }
      }

      // Load metaphors if function exists
      if (typeof loadMetaphors === 'function') {
        loadMetaphors();
      }

      // Set initial mode from URL hash
      if (typeof initModeFromHash === 'function') {
        initModeFromHash();
      }
    });
  </script>

</body>
</html>
